<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>CFD アラート設定</title>

  <!-- PWA: ホーム画面に追加するための manifest（正しい link タグ） -->
  <link>/manifest.json

  <!-- OneSignal SDK（正しい script タグ） -->
  https://cdn.onesignal.com/sdks/OneSignalSDK.js</script>

  <meta name="theme-color" content="#0b1220">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; background:#0b1220; color:#e8eef9; }
    header { padding:18px 20px; border-bottom:1px solid #222; }
    main { padding:20px; max-width:860px; margin:0 auto; }
    .note { color:#9aa4b2; }
    .card { background:#121826; border:1px solid #1e2636; border-radius:10px; padding:16px; margin:16px 0; }
    button { cursor:pointer; background:#3b82f6; color:#fff; border:none; border-radius:8px; padding:10px 14px; font-weight:600; }
    button.secondary { background:#263247; }
  </style>
</head>

<body>
  <header>
    <h1>CFD アラート設定</h1>
    <div class="note">
      iPhoneはSafariでこのページを開き、<b>共有 → ホーム画面に追加</b>してPWAから起動してください。<br>
      通知が来ない場合：HTTPS／<code>manifest.json</code>／<code>OneSignalSDKWorker.js</code>の配置を確認。
    </div>
  </header>

  <main>
    <section class="card">
      <h2>通知テスト</h2>
      <button id="btn-perm">通知を許可</button>
      <button id="btn-test" class="secondary">テスト通知</button>
      <span id="perm-status" class="note"></span>
    </section>
  </main>

  <!-- あなたの値に置き換え -->
  <script>
    const ONESIGNAL_APP_ID = "9fd9891c-2b88-49ba-8df2-3e3adb27e7bc"; // ← OneSignal App ID
  </script>

  <!-- OneSignal 初期化 -->
  <script>
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function () {
      OneSignal.init({ appId: ONESIGNAL_APP_ID });

      OneSignal.isPushNotificationsEnabled().then((enabled) => {
        setPermStatus(enabled ? "通知許可済み" : "未許可", enabled);
      });
      OneSignal.on('subscriptionChange', (isSubscribed) => {
        setPermStatus(isSubscribed ? "購読中（通知可能）" : "未購読", isSubscribed);
      });
    });

    document.getElementById("btn-perm").addEventListener("click", () => {
      OneSignal.Slidedown.promptPush();
    });

    document.getElementById("btn-test").addEventListener("click", async () => {
      try {
        const reg = await navigator.serviceWorker.getRegistration();
        if (reg && reg.showNotification) {
          await reg.showNotification("CFD Alert（テスト）", {
            body: "この端末で通知を受け取れるかの簡易テストです。",
            icon: "/icon-192.png",
          });
          setPermStatus("テスト通知を送信しました。", true);
        } else {
          setPermStatus("Service Worker未登録の可能性", false);
        }
      } catch (e) {
        console.error(e);
        setPermStatus("テスト通知の送信に失敗しました。", false);
      }
    });

    function setPermStatus(text, ok) {
      const el = document.getElementById("perm-status");
      el.textContent = text;
      el.className = ok ? "note ok" : "note err";
    }
  </script>

  <script>https://s3.tradingview.com/tv.js</script>
</body>
</html>







